<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sayan's Stickman Action</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --primary: #ff3131; --secondary: #00d2ff; --accent: #00ff9d; --throw: #ff9d00; }
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Arial Black', sans-serif; color: #fff; touch-action: none; user-select: none; }
        
        /* Disable Context Menu specifically for game feel */
        canvas { display: block; }

        @media (orientation: portrait) { #rotate-overlay { display: flex !important; } }
        #rotate-overlay { position: fixed; inset: 0; background: #000; z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; }

        .screen { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; background: rgba(0,0,0,0.95); }
        .menu-card { background: #111; padding: 25px; border-radius: 15px; border: 4px solid var(--primary); text-align: center; width: 85%; max-width: 900px; max-height: 90vh; overflow-y: auto; box-shadow: 0 0 50px rgba(255,49,49,0.3); }
        
        h1 { font-size: 2.2em; margin: 0; color: var(--primary); text-shadow: 0 0 10px var(--primary); }
        .sayan-credit { font-size: 1.4em; color: var(--secondary); margin: 15px 0; animation: float 3s infinite ease-in-out; display: block; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        .weapon-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin: 20px 0; }
        .weapon-item { background: #222; border: 2px solid #444; padding: 15px 10px; border-radius: 10px; cursor: pointer; transition: 0.2s; position: relative; display: flex; flex-direction: column; align-items: center; }
        .weapon-item.selected { border-color: var(--accent); background: #152b1e; transform: scale(1.05); }
        .dmg-display { font-size: 0.75em; color: var(--primary); font-weight: bold; margin-top: 5px; }
        .throw-badge { position: absolute; top: -5px; left: -5px; background: var(--throw); color: #000; font-size: 0.5em; padding: 2px 5px; border-radius: 4px; font-weight: bold; }

        button { background: var(--primary); color: #fff; border: none; padding: 15px 35px; margin: 10px; font-size: 1.1em; font-weight: 900; cursor: pointer; border-radius: 5px; }

        #hud { position: absolute; top: 15px; width: 100%; display: none; justify-content: space-between; align-items: flex-start; z-index: 50; padding: 0 40px; box-sizing: border-box; pointer-events: none; }
        .hp-bar { width: 100%; height: 25px; background: #333; border: 2px solid #fff; border-radius: 5px; overflow: hidden; position: relative; }
        .hp-fill { width: 100%; height: 100%; transition: width 0.3s; }
        #timer { font-size: 2.5em; font-weight: 900; background: rgba(0,0,0,0.5); padding: 5px 20px; border-radius: 10px; }

        #mobile-controls { position: absolute; inset: 0; display: none; pointer-events: none; z-index: 60; }
        #joystick-area { position: absolute; bottom: 0; left: 0; width: 45%; height: 60%; pointer-events: auto; }
        #action-area { position: absolute; bottom: 40px; right: 40px; display: flex; gap: 15px; pointer-events: auto; }
        .btn-round { width: 85px; height: 85px; background: rgba(0,0,0,0.7); border: 4px solid #fff; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.7em; }
        #btn-throw { border-color: var(--throw); color: var(--throw); display: none; }
        
        #end-screen { display: none; z-index: 200; }
        .result-msg { font-size: 5em; font-weight: 900; }
    </style>
</head>
<body oncontextmenu="return false;"> <!-- Global Right Click Disable -->

<div id="rotate-overlay"><h1>ðŸ”„ ROTATE PHONE</h1><p>Landscape Mode Required</p></div>

<div id="start-screen" class="screen">
    <div class="menu-card">
        <h1>SAYAN'S STICKMAN ACTION</h1>
        <span class="sayan-credit">Created by - Sayan Das</span>
        <button onclick="navToWeapon(false)">SINGLE PLAYER</button>
        <button onclick="navToPeer()">MULTIPLAYER (INVITE LINK)</button>
    </div>
</div>

<div id="peer-screen" class="screen" style="display:none;">
    <div class="menu-card">
        <h2>INVITE FRIEND</h2>
        <div id="link-box" style="background:#222; padding:15px; border-radius:10px; word-break:break-all; font-size:0.7em; border:1px dashed var(--secondary); margin-bottom:15px;">
            Generating...
        </div>
        <button onclick="copyLink()" style="background:var(--secondary); color:#000;">COPY LINK</button>
        <button onclick="location.reload()">BACK</button>
    </div>
</div>

<div id="weapon-screen" class="screen" style="display:none;">
    <div class="menu-card">
        <h2 style="color:var(--accent);">SELECT WEAPON</h2>
        <div class="weapon-grid" id="weapon-grid"></div>
        <button onclick="navToInstr()" style="background:var(--accent); color:#000; width:90%;">READY</button>
    </div>
</div>

<div id="instr-layer" class="screen" style="display:none;">
    <div class="menu-card" style="border-color: var(--accent);">
        <h2 style="color: var(--accent);">CONTROLS</h2>
        <div style="text-align:left; font-size:0.85em; background:#222; padding:15px; border-radius:10px;">
            <p><b>PC:</b> WASD to Move | Left Click: Attack | Right Click: Kick | <b>Space: Throw</b></p>
            <p><b>MOBILE:</b> Left Joystick | Action Buttons | <b>Orange Button: Throw</b></p>
        </div>
        <button onclick="initMatch()" style="background: var(--accent); color: #000; width: 100%; margin-top:20px;">START FIGHT</button>
    </div>
</div>

<div id="hud">
    <div style="width:35%"><div class="hp-bar"><div id="p1-hp" class="hp-fill" style="background:var(--secondary);"></div></div></div>
    <div id="timer">01:20</div>
    <div style="width:35%"><div class="hp-bar"><div id="p2-hp" class="hp-fill" style="background:var(--primary);"></div></div></div>
</div>

<div id="mobile-controls">
    <div id="joystick-area"></div>
    <div id="action-area">
        <div class="btn-round" id="btn-throw"><span>ðŸ’«</span>THROW</div>
        <div class="btn-round" id="btn-punch"><span>ðŸ¥Š</span>ATTACK</div>
        <div class="btn-round" id="btn-kick"><span>ðŸ¦µ</span>KICK</div>
    </div>
</div>

<div id="end-screen" class="screen"><h1 id="end-msg" class="result-msg"></h1></div>

<canvas id="game-canvas"></canvas>

<script>
const weaponData = [
    { name: "Gloves", dmg: 10, range: 60, spd: 0.15, icon: "ðŸ¥Š", type: 'blunt', throwable: false },
    { name: "Sword", dmg: 22, range: 100, spd: 0.10, icon: "âš”ï¸", type: 'blade', throwable: false },
    { name: "Dagger", dmg: 16, range: 50, spd: 0.20, icon: "ðŸ”ª", type: 'blade', throwable: true },
    { name: "Spear", dmg: 20, range: 160, spd: 0.08, icon: "ðŸ”±", type: 'pole', throwable: true },
    { name: "Stick", dmg: 8, range: 110, spd: 0.12, icon: "ðŸ¥–", type: 'blunt', throwable: false },
    { name: "Axe", dmg: 32, range: 90, spd: 0.06, icon: "ðŸª“", type: 'heavy', throwable: true },
    { name: "Mace", dmg: 35, range: 85, spd: 0.05, icon: "ðŸ”¨", type: 'heavy', throwable: false },
    { name: "Boomerang", dmg: 18, range: 120, spd: 0.11, icon: "ðŸªƒ", type: 'blade', throwable: true },
    { name: "Katana", dmg: 26, range: 110, spd: 0.13, icon: "ðŸ—¡ï¸", type: 'blade', throwable: true },
    { name: "Knuckles", dmg: 12, range: 45, spd: 0.25, icon: "ðŸ¤œ", type: 'blunt', throwable: false }
];

const canvas = document.getElementById('game-canvas');
const ctx = canvas.getContext('2d');
let width, height, groundY, gameActive = false, timer = 80;
let player, enemy, isMultiplayer = false, conn, peer, selectedIdx = 0;
let floatingTexts = [];

function init() {
    width = window.innerWidth; height = window.innerHeight;
    canvas.width = width; canvas.height = height;
    groundY = height * 0.85; // Slightly higher to ensure legs are fully visible
}
window.addEventListener('resize', init);
init();

// P2P Invite System
window.onload = () => {
    const params = new URLSearchParams(window.location.search);
    const joinId = params.get('join');
    if(joinId) autoJoin(joinId);
};

function autoJoin(id) {
    peer = new Peer();
    peer.on('open', () => {
        conn = peer.connect(id);
        setupConn();
    });
}

function navToPeer() {
    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('peer-screen').style.display = 'flex';
    peer = new Peer();
    peer.on('open', (id) => {
        const link = window.location.origin + window.location.pathname + "?join=" + id;
        document.getElementById('link-box').innerText = link;
    });
    peer.on('connection', c => { conn = c; setupConn(); });
}

function copyLink() {
    navigator.clipboard.writeText(document.getElementById('link-box').innerText);
    alert("Invite Link Copied!");
}

function setupConn() {
    isMultiplayer = true;
    conn.on('open', () => navToWeapon(true));
    conn.on('data', d => {
        if(d.t==='init') { enemy.w = weaponData[d.v]; }
        else { enemy.x = d.x; enemy.y = d.y; enemy.state = d.s; enemy.hp = d.h; enemy.dir = d.d; enemy.thrown = d.th; enemy.pX = d.px; enemy.pY = d.py; }
    });
}

// GAME ENTITY
class Stickman {
    constructor(x, color, isAI, wIdx) {
        this.x = x; this.y = groundY; this.color = color;
        this.isAI = isAI; this.hp = 100; this.velX = 0; this.velY = 0;
        this.state = 'idle'; this.dir = (x < width/2) ? 1 : -1;
        this.animFrame = 0; this.w = weaponData[wIdx];
        this.thrown = false; this.pX = 0; this.pY = 0; this.pState = 'away';
    }

    update() {
        this.y += this.velY;
        if (this.y < groundY) this.velY += 0.4; else { this.y = groundY; this.velY = 0; }
        this.x += this.velX; this.velX *= 0.8;
        this.x = Math.max(50, Math.min(width - 50, this.x));

        if (this.thrown) {
            if (this.pState === 'away') {
                this.pX += 12 * this.dir;
                let target = (this === player) ? enemy : player;
                if (Math.abs(this.pX - target.x) < 50 && Math.abs(this.pY - (target.y-60)) < 60) {
                    target.hp -= (this.w.dmg * 0.5);
                    floatingTexts.push({x: target.x, y: target.y-120, txt: `-${Math.round(this.w.dmg*0.5)}`, life: 1});
                    this.pState = 'back';
                }
                if (Math.abs(this.pX - this.x) > width * 0.6) this.pState = 'back';
            } else {
                let dx = this.x - this.pX, dy = (this.y - 60) - this.pY;
                let dist = Math.sqrt(dx*dx + dy*dy);
                if (dist < 30) this.thrown = false;
                else { this.pX += (dx/dist) * 15; this.pY += (dy/dist) * 15; }
            }
        }

        this.animFrame += this.w.spd;
        if (this.state === 'attack' || this.state === 'kick') { if (this.animFrame > Math.PI) this.state = 'idle'; }
        if (this.isAI && gameActive) this.runAI();
    }

    draw() {
        ctx.save(); ctx.strokeStyle = this.color; ctx.lineWidth = 7; ctx.lineCap = 'round';
        ctx.shadowBlur = 10; ctx.shadowColor = this.color;
        const headY = this.y - 100;

        // Head
        ctx.beginPath(); ctx.arc(this.x, headY, 20, 0, Math.PI*2); ctx.stroke();
        // Body
        ctx.beginPath(); ctx.moveTo(this.x, headY + 20); ctx.lineTo(this.x, this.y - 45); ctx.stroke();
        
        // Legs
        let l1 = Math.sin(this.animFrame*2)*25, l2 = -l1;
        if(this.state !== 'walk' && this.state !== 'idle') { l1 = 0; l2 = (this.state==='kick') ? 60*this.dir : 0; }
        ctx.beginPath(); ctx.moveTo(this.x, this.y - 45); ctx.lineTo(this.x - 15 + l1, this.y); 
        ctx.moveTo(this.x, this.y - 45); ctx.lineTo(this.x + 15 + l2, this.y); ctx.stroke();

        // Arms & Weapon
        if (!this.thrown) {
            let armX = this.x + (this.state === 'attack' ? 60*this.dir : 25*this.dir);
            ctx.beginPath(); ctx.moveTo(this.x, headY + 40); ctx.lineTo(armX, headY + 50); ctx.stroke();
            ctx.font = "40px Arial"; ctx.fillText(this.w.icon, armX-15, headY+65);
        } else {
            ctx.font = "40px Arial"; ctx.fillText(this.w.icon, this.pX-15, this.pY+15);
        }
        ctx.restore();
    }

    attack(type) {
        if (this.state === 'idle' || this.state === 'walk') {
            this.state = type; this.animFrame = 0;
            const target = (this === player) ? enemy : player;
            if (Math.abs(this.x - target.x) < (type==='attack'?this.w.range : 80)) {
                let d = (type==='attack') ? this.w.dmg : 10;
                target.hp -= d;
                floatingTexts.push({x: target.x, y: target.y-120, txt: `-${d}`, life: 1});
            }
        }
    }

    throw() { if(this.w.throwable && !this.thrown) { this.thrown = true; this.pX = this.x; this.pY = this.y-60; this.pState = 'away'; } }

    runAI() {
        let gap = this.x - player.x;
        if(Math.abs(gap) > this.w.range) this.velX = gap > 0 ? -3 : 3;
        else if (Math.random() < 0.02) this.attack('attack');
    }
}

// MATCH ENGINE
function navToWeapon(multi) {
    isMultiplayer = multi; document.getElementById('start-screen').style.display = 'none';
    document.getElementById('peer-screen').style.display = 'none';
    document.getElementById('weapon-screen').style.display = 'flex';
    document.getElementById('weapon-grid').innerHTML = weaponData.map((w, i) => `
        <div class="weapon-item ${i===selectedIdx?'selected':''}" onclick="setW(${i}, this)">
            ${w.throwable ? '<div class="throw-badge">THROWABLE</div>' : ''}
            <span style="font-size:2em">${w.icon}</span><b>${w.name}</b>
            <div class="dmg-display">POWER: ${w.dmg}</div>
        </div>
    `).join('');
}

function setW(i, el) { selectedIdx = i; document.querySelectorAll('.weapon-item').forEach(x => x.classList.remove('selected')); el.classList.add('selected'); }
function navToInstr() { document.getElementById('weapon-screen').style.display = 'none'; document.getElementById('instr-layer').style.display = 'flex'; }

function initMatch() {
    document.getElementById('instr-layer').style.display = 'none'; document.getElementById('hud').style.display = 'flex';
    if ('ontouchstart' in window) { document.getElementById('mobile-controls').style.display = 'block'; if (weaponData[selectedIdx].throwable) document.getElementById('btn-throw').style.display = 'flex'; }
    player = new Stickman(width * 0.2, '#00d2ff', false, selectedIdx);
    enemy = new Stickman(width * 0.8, '#ff3131', !isMultiplayer, Math.floor(Math.random()*10));
    if (isMultiplayer) conn.send({t: 'init', v: selectedIdx});
    gameActive = true; 
    const tInt = setInterval(() => { if (!gameActive) clearInterval(tInt); else { timer--; if(timer<=0) resolve(); } }, 1000);
    render();
}

function render() {
    if (!gameActive) return;
    ctx.fillStyle = '#0a0a0a'; ctx.fillRect(0,0,width,height);
    ctx.fillStyle = '#1a1a1a'; ctx.fillRect(0, groundY, width, height-groundY);
    if (keys['KeyA']) { player.velX = -3.5; player.dir = -1; } if (keys['KeyD']) { player.velX = 3.5; player.dir = 1; }
    player.update(); enemy.update(); player.draw(); enemy.draw();
    for (let i = floatingTexts.length-1; i >= 0; i--) {
        let t = floatingTexts[i]; ctx.fillStyle = `rgba(255,0,0,${t.life})`; ctx.font = "bold 25px Arial";
        ctx.fillText(t.txt, t.x, t.y); t.y -= 2; t.life -= 0.02; if (t.life <= 0) floatingTexts.splice(i, 1);
    }
    document.getElementById('timer').innerText = `0${Math.floor(timer/60)}:${(timer%60).toString().padStart(2,'0')}`;
    document.getElementById('p1-hp').style.width = player.hp + "%"; document.getElementById('p2-hp').style.width = enemy.hp + "%";
    if (isMultiplayer) conn.send({x:player.x, y:player.y, s:player.state, h:player.hp, d:player.dir, th:player.thrown, px:player.pX, py:player.pY});
    if (player.hp <= 0 || enemy.hp <= 0) resolve(); else requestAnimationFrame(render);
}

function resolve() {
    gameActive = false;
    const win = player.hp > enemy.hp;
    document.getElementById('end-screen').style.display = 'flex';
    const msg = document.getElementById('end-msg');
    msg.innerText = win ? "YOU WON !" : "YOU LOSE !";
    msg.className = win ? "result-msg win-text" : "result-msg lose-text";
    setTimeout(() => { window.location.href = window.location.origin + window.location.pathname; }, 4000);
}

// PC CONTROLS (Right Click Fixed)
const keys = {};
window.onkeydown = e => { keys[e.code] = true; if(e.code==='KeyW' && player.y>=groundY) player.velY = -12; if(e.code==='Space') player.throw(); };
window.onkeyup = e => keys[e.code] = false;
window.onmousedown = e => { if(!gameActive) return; if(e.button===0) player.attack('attack'); if(e.button===2) player.attack('kick'); };

// MOBILE CONTROLS
let j = { active: false, x: 0, y: 0 };
const jArea = document.getElementById('joystick-area');
jArea.addEventListener('touchstart', e => { j.active = true; j.x = e.touches[0].clientX; j.y = e.touches[0].clientY; });
jArea.addEventListener('touchmove', e => { if (!j.active) return; let dx = e.touches[0].clientX-j.x, dy = e.touches[0].clientY-j.y; if(dx>20){player.velX=3.5;player.dir=1;} if(dx<-20){player.velX=-3.5;player.dir=-1;} if(dy<-35&&player.y>=groundY)player.velY=-12; });
jArea.addEventListener('touchend', () => j.active = false);
document.getElementById('btn-punch').ontouchstart = () => player.attack('attack');
document.getElementById('btn-kick').ontouchstart = () => player.attack('kick');
document.getElementById('btn-throw').ontouchstart = () => player.throw();

</script>
</body>
</html>