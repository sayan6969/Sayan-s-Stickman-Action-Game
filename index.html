<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sayan's Stickman Action</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --primary: #ff3131; --secondary: #00d2ff; --accent: #00ff9d; --throw: #ff9d00; }
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Arial Black', sans-serif; color: #fff; touch-action: none; user-select: none; }
        
        @media (orientation: portrait) { #rotate-overlay { display: flex !important; } }
        #rotate-overlay { position: fixed; inset: 0; background: #000; z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; }

        .screen { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; background: rgba(0,0,0,0.95); }
        .menu-card { background: #111; padding: 25px; border-radius: 15px; border: 4px solid var(--primary); text-align: center; width: 85%; max-width: 900px; max-height: 90vh; overflow-y: auto; box-shadow: 0 0 50px rgba(255,49,49,0.3); }
        
        h1 { font-size: 2.2em; margin: 0; color: var(--primary); text-shadow: 0 0 10px var(--primary); }
        .sayan-credit { font-size: 1.4em; color: var(--secondary); margin: 15px 0; animation: float 3s infinite ease-in-out; display: block; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        .weapon-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin: 20px 0; }
        .weapon-item { background: #222; border: 2px solid #444; padding: 15px 10px; border-radius: 10px; cursor: pointer; transition: 0.2s; position: relative; display: flex; flex-direction: column; align-items: center; }
        .weapon-item.selected { border-color: var(--accent); background: #152b1e; transform: scale(1.05); box-shadow: 0 0 15px var(--accent); }
        
        .dmg-display { font-size: 0.7em; color: var(--primary); font-weight: bold; margin-top: 5px; background: rgba(255,49,49,0.1); padding: 2px 8px; border-radius: 4px; }
        .throw-badge { position: absolute; top: -5px; left: -5px; background: var(--throw); color: #000; font-size: 0.5em; padding: 2px 5px; border-radius: 4px; font-weight: bold; }

        button { background: var(--primary); color: #fff; border: none; padding: 15px 35px; margin: 10px; font-size: 1.1em; font-weight: 900; cursor: pointer; border-radius: 5px; }
        
        #hud { position: absolute; top: 15px; width: 100%; display: none; justify-content: space-between; align-items: flex-start; z-index: 50; padding: 0 40px; box-sizing: border-box; pointer-events: none; }
        .hp-bar { width: 100%; height: 22px; background: #333; border: 2px solid #fff; border-radius: 5px; overflow: hidden; }
        .hp-fill { width: 100%; height: 100%; transition: width 0.3s; }
        #timer { font-size: 2.2em; font-weight: 900; background: rgba(0,0,0,0.6); padding: 5px 20px; border-radius: 10px; border: 1px solid #444; }

        #mobile-controls { position: absolute; inset: 0; display: none; pointer-events: none; z-index: 60; }
        #joystick-area { position: absolute; bottom: 0; left: 0; width: 45%; height: 60%; pointer-events: auto; }
        #action-area { position: absolute; bottom: 40px; right: 40px; display: flex; gap: 15px; pointer-events: auto; }
        .btn-round { width: 85px; height: 85px; background: rgba(0,0,0,0.7); border: 4px solid #fff; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.7em; }
        #btn-throw { border-color: var(--throw); color: var(--throw); display: none; }

        #end-screen { display: none; z-index: 200; background: rgba(0,0,0,0.9); }
    </style>
</head>
<body>

<div id="rotate-overlay"><h1>üîÑ ROTATE PHONE</h1><p>Landscape Mode Required</p></div>

<div id="start-screen" class="screen">
    <div class="menu-card">
        <h1>SAYAN'S STICKMAN ACTION</h1>
        <span class="sayan-credit">Created by - Sayan Das</span>
        <button onclick="navToWeapon(false)">SINGLE PLAYER</button>
        <button onclick="navToPeer()">BLUETOOTH P2P</button>
    </div>
</div>

<div id="weapon-screen" class="screen" style="display:none;">
    <div class="menu-card">
        <h2 style="color:var(--accent); margin:0;">SELECT WEAPON</h2>
        <div class="weapon-grid" id="weapon-grid"></div>
        <button onclick="navToInstr()" style="background:var(--accent); color:#000; width:90%;">CONFIRM</button>
    </div>
</div>

<div id="instr-layer" class="screen" style="display:none;">
    <div class="menu-card" style="border-color: var(--accent);">
        <h2 style="color: var(--accent);">NATURAL SPEED CONTROLS</h2>
        <div style="text-align:left; font-size:0.85em; background: #222; padding: 15px; border-radius: 10px;">
            <p><b>PC:</b> WASD to Move | Left Click: Attack | Right Click: Kick | <b>Space: Throw</b></p>
            <p><b>MOBILE:</b> Left Joystick | Attack/Kick | <b>Orange Button: Throw</b></p>
        </div>
        <button onclick="initMatch()" style="background: var(--accent); color: #000; width: 100%; margin-top:20px;">START FIGHT</button>
    </div>
</div>

<div id="peer-screen" class="screen" style="display:none;">
    <div class="menu-card">
        <h2>PAIRING</h2>
        <p>Your ID: <span id="my-id" style="color:var(--secondary)">...</span></p>
        <input type="text" id="peer-id-input" placeholder="ID" style="padding:10px; width:70%; text-align:center;"><br>
        <button onclick="connectToPeer()">CONNECT</button>
        <button onclick="location.reload()">BACK</button>
    </div>
</div>

<div id="hud">
    <div style="width:35%"><div class="hp-bar"><div id="p1-hp" class="hp-fill" style="background:var(--secondary);"></div></div></div>
    <div id="timer">01:20</div>
    <div style="width:35%"><div class="hp-bar"><div id="p2-hp" class="hp-fill" style="background:var(--primary);"></div></div></div>
</div>

<div id="mobile-controls">
    <div id="joystick-area"></div>
    <div id="action-area">
        <div class="btn-round" id="btn-throw"><span>üí´</span>THROW</div>
        <div class="btn-round" id="btn-punch"><span>ü•ä</span>ATTACK</div>
        <div class="btn-round" id="btn-kick"><span>ü¶µ</span>KICK</div>
    </div>
</div>

<div id="end-screen" class="screen">
    <h1 id="end-msg"></h1>
    <p>Returning to Lobby...</p>
</div>

<canvas id="game-canvas"></canvas>

<script>
// Scaled speeds for "Natural 1x" feel
const weaponData = [
    { name: "Gloves", dmg: 10, range: 45, spd: 0.12, icon: "ü•ä", type: 'blunt', throwable: false },
    { name: "Sword", dmg: 22, range: 90, spd: 0.08, icon: "‚öîÔ∏è", type: 'blade', throwable: false },
    { name: "Dagger", dmg: 16, range: 40, spd: 0.18, icon: "üî™", type: 'blade', throwable: true },
    { name: "Spear", dmg: 20, range: 150, spd: 0.06, icon: "üî±", type: 'pole', throwable: true },
    { name: "Bow", dmg: 14, range: 140, spd: 0.05, icon: "üèπ", type: 'ranged', throwable: false },
    { name: "Stick", dmg: 8, range: 100, spd: 0.10, icon: "ü•ñ", type: 'blunt', throwable: false },
    { name: "Axe", dmg: 32, range: 85, spd: 0.04, icon: "ü™ì", type: 'heavy', throwable: true },
    { name: "Mace", dmg: 35, range: 80, spd: 0.03, icon: "üî®", type: 'heavy', throwable: false },
    { name: "Boomerang", dmg: 18, range: 110, spd: 0.09, icon: "ü™É", type: 'blade', throwable: true },
    { name: "Katana", dmg: 26, range: 100, spd: 0.11, icon: "üó°Ô∏è", type: 'blade', throwable: true },
    { name: "Nunchaku", dmg: 16, range: 65, spd: 0.20, icon: "‚õìÔ∏è", type: 'blunt', throwable: false },
    { name: "Knuckles", dmg: 12, range: 35, spd: 0.25, icon: "ü§ú", type: 'blunt', throwable: false }
];

const canvas = document.getElementById('game-canvas');
const ctx = canvas.getContext('2d');
let width, height, groundY, gameActive = false, timer = 80;
let player, enemy, isMultiplayer = false, conn, peer, selectedIdx = 0;
let floatingTexts = [];

function init() {
    width = window.innerWidth; height = window.innerHeight;
    canvas.width = width; canvas.height = height;
    groundY = height * 0.8;
}
window.addEventListener('resize', init);
init();

class Stickman {
    constructor(x, color, isAI, wIdx) {
        this.x = x; this.y = groundY; this.color = color;
        this.isAI = isAI; this.hp = 100; this.velX = 0; this.velY = 0;
        this.state = 'idle'; this.dir = (x < width/2) ? 1 : -1;
        this.animFrame = 0; this.w = weaponData[wIdx];
        this.swingAngle = 0;
        this.thrown = false; this.pX = 0; this.pY = 0; this.pState = 'away'; 
    }

    update() {
        // Natural Physics
        this.y += this.velY;
        if (this.y < groundY) this.velY += 0.35; // Lower Gravity
        else { this.y = groundY; this.velY = 0; }
        
        this.x += this.velX; 
        this.velX *= 0.82; // Natural deceleration
        this.x = Math.max(40, Math.min(width - 40, this.x));

        // Natural Projectile Speed
        if (this.thrown) {
            if (this.pState === 'away') {
                this.pX += 11 * this.dir; // Visually trackable speed
                let target = (this === player) ? enemy : player;
                let distToTarget = Math.sqrt(Math.pow(this.pX - target.x, 2) + Math.pow(this.pY - (target.y - 60), 2));
                if (distToTarget < 50) {
                    let throwDmg = this.w.dmg * 0.5;
                    target.hp -= throwDmg; target.velX = this.dir * 4;
                    floatingTexts.push({ x: target.x, y: target.y - 120, txt: `-${Math.round(throwDmg)}`, life: 1 });
                    this.pState = 'back';
                }
                if (Math.abs(this.pX - this.x) > width * 0.55) this.pState = 'back';
            } else {
                let dx = this.x - this.pX; let dy = (this.y - 60) - this.pY;
                let dist = Math.sqrt(dx*dx + dy*dy);
                if (dist < 30) this.thrown = false;
                else { this.pX += (dx/dist) * 14; this.pY += (dy/dist) * 14; }
            }
        }

        // Natural Animation Ticks
        this.animFrame += this.w.spd;
        if (this.state === 'attack' || this.state === 'kick') {
            if (this.animFrame > Math.PI) { this.state = 'idle'; this.swingAngle = 0; }
            else this.swingAngle = Math.sin(this.animFrame) * 1.6;
        } else if (this.y < groundY) this.state = 'jump';
        else if (Math.abs(this.velX) > 0.5) this.state = 'walk';
        else this.state = 'idle';
        if (this.isAI && gameActive) this.runAI();
    }

    draw() {
        ctx.save(); ctx.strokeStyle = this.color; ctx.lineWidth = 6; ctx.lineCap = 'round';
        ctx.shadowBlur = 8; ctx.shadowColor = this.color;
        const headY = this.y - 100;
        ctx.beginPath(); ctx.arc(this.x, headY, 18, 0, Math.PI*2); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(this.x, headY + 18); ctx.lineTo(this.x, this.y - 40); ctx.stroke();
        let l1 = 0, l2 = 0;
        if (this.state === 'walk') { l1 = Math.sin(this.animFrame * 1.2) * 28; l2 = -l1; }
        else if (this.state === 'kick') l2 = 65 * this.dir;
        ctx.beginPath(); ctx.moveTo(this.x, this.y - 40); ctx.lineTo(this.x - 12 + l1, this.y);
        ctx.moveTo(this.x, this.y - 40); ctx.lineTo(this.x + 12 + l2, this.y); ctx.stroke();

        if (!this.thrown) {
            let armX = this.x + 18 * this.dir, armY = headY + 45;
            if (this.state === 'attack') { armX = this.x + Math.cos(this.swingAngle - 0.5) * this.w.range * 0.8 * this.dir; armY = headY + 35 + Math.sin(this.swingAngle - 0.5) * 45; }
            this.drawWeapon(this.x + (this.state === 'attack' ? 10 : 20)*this.dir, headY + 40, this.swingAngle);
            ctx.beginPath(); ctx.moveTo(this.x, headY + 35); ctx.lineTo(this.x - 18 * this.dir, headY + 55); 
            ctx.moveTo(this.x, headY + 35); ctx.lineTo(armX, armY); ctx.stroke();
        } else {
            this.drawWeapon(this.pX, this.pY, Date.now() / 80);
            ctx.beginPath(); ctx.moveTo(this.x, headY + 35); ctx.lineTo(this.x - 18 * this.dir, headY + 55); 
            ctx.moveTo(this.x, headY + 35); ctx.lineTo(this.x + 18 * this.dir, headY + 55); ctx.stroke();
        }
        ctx.restore();
    }

    drawWeapon(wx, wy, angle) {
        ctx.save(); ctx.translate(wx, wy); ctx.rotate(angle * this.dir);
        ctx.strokeStyle = "#eee"; ctx.lineWidth = 5;
        const len = this.w.range; const d = this.dir;
        if (this.w.type === 'blade') { ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(len * d, -12); ctx.stroke(); }
        else if (this.w.type === 'pole') { ctx.strokeStyle = "#852"; ctx.beginPath(); ctx.moveTo(-30*d,0); ctx.lineTo(len*d,0); ctx.stroke(); }
        else if (this.w.type === 'heavy') { ctx.strokeStyle = "#666"; ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(len*d,0); ctx.stroke(); }
        else { ctx.font = "35px Arial"; ctx.fillText(this.w.icon, -15, 10); }
        ctx.restore();
    }

    throw() { if (this.w.throwable && !this.thrown) { this.thrown = true; this.pX = this.x; this.pY = this.y - 60; this.pState = 'away'; } }

    performAttack(type) { if (this.state === 'idle' || this.state === 'walk' || this.state === 'jump') { this.state = type; this.animFrame = 0; this.hitCheck(type); } }

    hitCheck(type) {
        const target = (this === player) ? enemy : player;
        const dist = Math.abs(this.x - target.x);
        const reach = type === 'attack' ? this.w.range + 30 : 80;
        const damage = type === 'attack' ? this.w.dmg : 10;
        if (dist < reach && Math.abs(this.y - target.y) < 120) {
            target.hp = Math.max(0, target.hp - damage);
            floatingTexts.push({ x: target.x, y: target.y - 120, txt: `-${Math.round(damage)}`, life: 1 });
        }
    }

    runAI() {
        let gap = this.x - player.x;
        if (Math.abs(gap) > 350 && this.w.throwable && Math.random() < 0.008) this.throw();
        if (Math.abs(gap) > this.w.range) { this.velX = gap > 0 ? -3 : 3; this.dir = gap > 0 ? -1 : 1; }
        else if (Math.random() < 0.02) this.performAttack(Math.random() > 0.4 ? 'attack' : 'kick');
    }
}

function navToWeapon(multi) {
    isMultiplayer = multi; document.getElementById('start-screen').style.display = 'none';
    document.getElementById('weapon-screen').style.display = 'flex';
    const grid = document.getElementById('weapon-grid');
    grid.innerHTML = weaponData.map((w, i) => `
        <div class="weapon-item ${i===selectedIdx?'selected':''}" onclick="setW(${i}, this)">
            ${w.throwable ? '<div class="throw-badge">THROWABLE</div>' : ''}
            <span style="font-size:1.8em">${w.icon}</span>
            <span style="font-size:0.8em; margin-top:5px;">${w.name}</span>
            <div class="dmg-display">POWER: ${w.dmg}</div>
        </div>
    `).join('');
}

function setW(i, el) { selectedIdx = i; document.querySelectorAll('.weapon-item').forEach(x => x.classList.remove('selected')); el.classList.add('selected'); }
function navToInstr() { document.getElementById('weapon-screen').style.display = 'none'; document.getElementById('instr-layer').style.display = 'flex'; }
function initMatch() {
    document.getElementById('instr-layer').style.display = 'none'; document.getElementById('hud').style.display = 'flex';
    if ('ontouchstart' in window) { document.getElementById('mobile-controls').style.display = 'block'; if (weaponData[selectedIdx].throwable) document.getElementById('btn-throw').style.display = 'flex'; }
    player = new Stickman(width * 0.2, '#00d2ff', false, selectedIdx);
    enemy = new Stickman(width * 0.8, '#ff3131', !isMultiplayer, Math.floor(Math.random()*12));
    if (isMultiplayer) conn.send({t: 'init', v: selectedIdx});
    timer = 80; gameActive = true; 
    const tLoop = setInterval(() => { if (!gameActive) { clearInterval(tLoop); return; } timer--; if (timer <= 0) resolveMatch(); }, 1000);
    render();
}

function render() {
    if (!gameActive) return;
    ctx.fillStyle = '#0a0a0a'; ctx.fillRect(0,0,width,height);
    ctx.fillStyle = '#1a1a1a'; ctx.fillRect(0, groundY, width, height-groundY);
    if (keys['KeyA']) { player.velX = -3.5; player.dir = -1; }
    if (keys['KeyD']) { player.velX = 3.5; player.dir = 1; }
    player.update(); enemy.update(); player.draw(); enemy.draw();
    for (let i = floatingTexts.length-1; i >= 0; i--) {
        let t = floatingTexts[i]; ctx.fillStyle = `rgba(255,0,0,${t.life})`; ctx.font = "bold 25px Arial";
        ctx.fillText(t.txt, t.x, t.y); t.y -= 2; t.life -= 0.02; if (t.life <= 0) floatingTexts.splice(i, 1);
    }
    document.getElementById('timer').innerText = `0${Math.floor(timer/60)}:${(timer%60).toString().padStart(2,'0')}`;
    document.getElementById('p1-hp').style.width = player.hp + "%"; document.getElementById('p2-hp').style.width = enemy.hp + "%";
    if (isMultiplayer && conn) conn.send({x: player.x, y: player.y, s: player.state, h: player.hp, d: player.dir});
    if (player.hp <= 0 || enemy.hp <= 0) resolveMatch(); else requestAnimationFrame(render);
}

function resolveMatch() { if (!gameActive) return; gameActive = false; const win = player.hp > enemy.hp; const msg = document.getElementById('end-msg'); document.getElementById('end-screen').style.display = 'flex'; msg.innerText = win ? "YOU WON !" : "YOU LOSE !"; msg.className = win ? "win-text" : "lose-text"; setTimeout(() => { location.reload(); }, 4000); }

const keys = {};
window.onkeydown = e => { keys[e.code] = true; if (e.code === 'KeyW' && player.y >= groundY) player.velY = -11; if (e.code === 'Space') player.throw(); };
window.onkeyup = e => keys[e.code] = false;
window.onmousedown = e => { if(gameActive){ if(e.button===0) player.performAttack('attack'); if(e.button===2) player.performAttack('kick'); }};
window.oncontextmenu = e => e.preventDefault();

let j = { active: false, x: 0, y: 0 };
const jArea = document.getElementById('joystick-area');
jArea.addEventListener('touchstart', e => { j.active = true; j.x = e.touches[0].clientX; j.y = e.touches[0].clientY; });
jArea.addEventListener('touchmove', e => { if (!j.active) return; let dx = e.touches[0].clientX - j.x; let dy = e.touches[0].clientY - j.y; if (dx > 25) { player.velX = 3.5; player.dir = 1; } if (dx < -25) { player.velX = -3.5; player.dir = -1; } if (dy < -40 && player.y >= groundY) player.velY = -11; });
jArea.addEventListener('touchend', () => j.active = false);

document.getElementById('btn-punch').ontouchstart = () => player.performAttack('attack');
document.getElementById('btn-kick').ontouchstart = () => player.performAttack('kick');
document.getElementById('btn-throw').ontouchstart = () => player.throw();

function navToPeer() { document.getElementById('start-screen').style.display = 'none'; document.getElementById('peer-screen').style.display = 'flex'; peer = new Peer(); peer.on('open', id => document.getElementById('my-id').innerText = id); peer.on('connection', c => { conn = c; listen(); }); }
function connectToPeer() { conn = peer.connect(document.getElementById('peer-id-input').value); listen(); }
function listen() { conn.on('open', () => navToWeapon(true)); conn.on('data', d => { if(d.t==='init')enemy.w=weaponData[d.v];else{enemy.x=d.x;enemy.y=d.y;enemy.state=d.s;enemy.hp=d.h;enemy.dir=d.d;}}); }
</script>
</body>
</html>